services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: askmynotes-web
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      APP_URL: http://localhost:3000
      JWT_SECRET: ${JWT_SECRET:-askmynotes-dev-secret-key}
      MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/askmynotes}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      LLM_MODEL: ${LLM_MODEL:-gpt-4o-mini}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}
      UPLOAD_DIR: /app/data/uploads
      RETRIEVAL_THRESHOLD: ${RETRIEVAL_THRESHOLD:-0.2}
      RETRIEVAL_MIN_CHUNKS: ${RETRIEVAL_MIN_CHUNKS:-2}
    volumes:
      - uploads_data:/app/data/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: askmynotes-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

volumes:
  mongo_data:
  uploads_data:
